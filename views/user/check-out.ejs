<%- include('./includes/user-header')%>
    <%- include('./includes/user-navbar')%>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>




        <!-- page-title -->
  <!-- Preloader -->
  <div class="loader-wrap">
    <div class="preloader">
      <div class="preloader-close">Preloader Close</div>
    </div>
    <div class="layer layer-one"><span class="overlay"></span></div>
    <div class="layer layer-two"><span class="overlay"></span></div>
    <div class="layer layer-three"><span class="overlay"></span></div>
  </div>

        <!-- checkout-section -->
        <section class="checkout-section">
            <div class="container">

                
                    <div class="accordion m-4" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                               
                                    
                                <button class="accordion-button collapsed text-bold " type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false"
                                    aria-controls="collapseThree">
                                    Saved Address
                                </button>
                                  
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div class="row">
                                        <!-- <div class="col-md-3"> --> 
                                         <%if(address.length!=0){%>   
                                        <%for (let i =0 ; i< address.length ; i++) {%>
                                            <div class="card col-md-3 m-2" style="width: 18rem;">
                                                <div class="card-body">

                                                    <!-- <h5 class="card-title">Card title</h5> -->
                                                    <!-- <h6 class="card-subtitle mb-2 text-muted">Card subtitle</h6> -->
                                                    <li class="card-text" id="name<%=i%>"><%=address[i].name%></li>
                                                    <li class="card-text" id="houseName1<%=i%>"><%=address[i].houseName%></li>
                                                    <li class="card-text" id="pincode1<%=i%>"><%=address[i].pincode%></li>
                                                    <li class="card-text" id="city1<%=i%>"><%=address[i].city%></li>
                                                    <li class="card-text" id="state1<%=i%>"><%=address[i].state%></li>
                                                    <li class="card-text" id="phoneNumber1<%=i%>"><%=address[i].phoneNumber%></li>
                                                    <a onclick="address('<%=i%>')" class="card-link btn btn-success">Use</a>
                                                   
                                                </div>
                                            </div>
                                            <%}%>
                                            <%}else{%>
                                                <h4><a href="/address">Add Address</a></h4>
                                                <%}%>
                                                <!-- </div> -->

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        

                    

                        <div class="row">
                            <div class="othre-content clearfix border">
                                <div id="couponError" class="">
                                    <h6></h6>
                                </div>
                                <div class="row p-2"> 
                                    <div class="col-6">
                                        <div class="coupon-box pull-left clearfix id=err">
                                            <input type="text" name="couponCode" id="couponCode"
                                                placeholder="&nbsp;&nbsp;Enter coupon code...">
                                            <button onclick="coupon()" class="theme-btn-two">Apply coupon<i type="button"
                                                    class="flaticon-right-1"></i></a></button>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="text-center mt-1 float-right btn btn-dark" data-toggle="modal"
                                        data-target="#exampleModalLong">
                                        view coupons
                                    </button>
                                    </div>
                                    
                            </div>
                               
                                <!-- modal -->
                                <!-- Button trigger modal -->
                              
                                <!-- Modal -->
                                <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog"
                                    aria-labelledby="exampleModalLongTitle" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLongTitle">Available coupons
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <%showCoupon.forEach(function(show){%>
                                                <div class="modal-body">
                                                    
                                                    <h6>Coponcode:<span id="<%=show._id%>" class="code"><%=show.couponCode%></span><Button onclick="applyCoupon('<%=show._id%>')" class="btn btn-link">Apply</Button>
                                                    </h6>
                                                    
                                                      <h6>discount:<%=show.discountPercentage%>%</h6>
                                                    <h6>Applicable to min purchase of : <%=show.MinimumAmount%>
                                                    </h6>
                                                </div>
                                                <%})%>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                            data-dismiss="modal">Close</button>
                                                    </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- modal ends -->
                            </div>
                            <form action="" method="" class="billing-form" id="checkoutform">
                                <div class="row">
                                    <div class="col-lg-6 col-md-12 col-sm-12 left-column">
                                        <div class="inner-box">
                                            <div class="billing-info border">
                                                <h4 class="sub-title">Billing Details</h4>
                                                <div class="row">
                                                    <div class="col-lg-6 col-md-6 col-sm-12 form-group">
                                                        <label> &nbsp;Name*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="name" id="name">
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-6 col-md-6 col-sm-12 form-group">
                                                        <label>&nbsp;Phone Number*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="phone" id="phone">
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-12 col-md-12 col-sm-12 form-group">
                                                        <label>&nbsp;Address*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="address" class="address"
                                                                id="address">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-12 col-md-12 col-sm-12 form-group">
                                                        <label>&nbsp;Town/City*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="town_city" id="city">
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6 col-md-6 col-sm-12 form-group">
                                                        <label>&nbsp;State*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="state" id="state">
                                                        </div>
                                                        <!-- <div class="select-column select-box">
                                                    <select class="selectmenu" id="select" id="ui-id-2" name="state">
                                                        <option selected="selected" id="state" value="0">Select Option
                                                        </option>
                                                        <option>kerala</option>
                                                        <option>Tamilnadu</option>
                                                        <option>Karnataka</option>
                                                    </select>
                                                </div> -->
                                                    </div>
                                                    <div class="col-lg-6 col-md-6 col-sm-12 form-group">
                                                        <label>Zip Code*</label>
                                                        <div class="field-input">
                                                            <input type="text" name="zip" id="zip">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12 col-sm-12 right-column">
                                        <div class="inner-box">
                                            <div class="order-info border">
                                                <h4 class="sub-title">Your Order</h4>
                                                <div class="order-product">
                                                    <ul class="order-list clearfix">
                                                        <li class="title clearfix">
                                                            <p>Product</p>
                                                            <span></span>
                                                        </li>
                                                        <%for (let i=0;i<cartArray.length;i++){%>
                                                            <li>
                                                                <div class="single-box clearfix">
                                                                    <img src="/productImages/<%=cart.cartProducts[i].productId.image[0]%>"
                                                                        alt="">
                                                                    <h6>
                                                                        <%=cartArray[i].name%>,&nbsp;qty:
                                                                            <%=cartArray[i].quantity%>
                                                                    </h6>
                                                                    <span>
                                                                        <%=cartArray[i].price%>
                                                                    </span>
                                                                </div>
                                                            </li>
                                                            <%}%>
                                                                <li class="order-total clearfix">

                                                                    <h6>&nbsp; order Total</h6>
                                                                    <span id="totalprice">
                                                                        <%=cart.total%>
                                                                    </span>
                                                                </li>
                                                                <div id="couponTotal">
                                                                    <li class="order-total clearfix">
                                                                        <h6>&nbsp;Discount</h6>
                                                                        <span>
                                                                            0
                                                                        </span>
                                                                    </li>
                                                                    <li class="order-total clearfix">
                                                                        <h6>Total</h6>
                                                                        <span>
                                                                        </span>
                                                                    </li>
                                                                </div>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="payment-info">
                                                <h4 class="sub-title">Payment Proccess</h4>
                                                <div class="payment-inner" id="">
                                                    <div class="option-block">
                                                        <div class="custom-controls-stacked">
                                                            <label class="custom-control radio-inline">
                                                                <input type="radio" name="paymentMethod" id="netbanking"
                                                                    value="netbanking" class="material-control-input">
                                                                <span class="material-control-indicator"></span>
                                                                <span class="description">online payment</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="option-block" id="inner">
                                                        <div class="custom-controls-stacked">
                                                            <label class="custom-control radio-inline">
                                                                <input type="radio" name="paymentMethod" value="cod"
                                                                    id="cod" class="material-control-input" checked>
                                                                <span class="material-control-indicator"></span>
                                                                <span class="description">Cash on delivery</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="btn-box">
                                                        <button type="button" onclick="checkout()"
                                                            class="theme-btn-two">Place
                                                            Your
                                                            Order<i class="flaticon-right-1"></i></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
            </div>
        </section>
        <!-- checkout-section end -->


        <%- include('./includes/user-footer')%>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
                function address(index) {
                    
                    // console.log(document.getElementById('name1').textContent);
                    document.getElementById('name').value = document.getElementById('name'+index).textContent
                    document.getElementById('address').value = document.getElementById('houseName1'+index).textContent
                    document.getElementById('zip').value = document.getElementById('pincode1'+index).textContent
                    document.getElementById('city').value = document.getElementById('city1'+index).textContent
                    document.getElementById('state').value = document.getElementById('state1'+index).textContent
                    document.getElementById('phone').value = document.getElementById('phoneNumber1'+index).textContent
                    // console.log(document.getElementById('zip').value)

                }

                function applyCoupon(id){
                    console.log(id);
                    console.log("helloo");
                    // let index = document.getElementsByClassName('code').innerText
                    
                    document.getElementById('couponCode').value = document.getElementById(id).innerHTML

                }



                function coupon() {
                    let couponCode = document.getElementById('couponCode').value
                    $.ajax({
                        url: '/applyCoupon',
                        data: { couponCode },
                        method: 'post',
                        success: (response) => {
                            if (response.couponObj) {
                                coupon = response.couponObj

                                
                                console.log(coupon);
                                let userCouponCart = document.getElementById('couponTotal')
                                let totalbill = document.getElementById('totalprice').innerText
                                console.log(totalbill);

                                console.log(userCouponCart);
                                let html = null
                                html = ` <div  id="couponTotal">
                                                            <li class="order-total clearfix">
                                                                <h6>&nbsp;Discount</h6>
                                                                <span>
                                                                    ${coupon.discount}
                                                                    
                                                                </span>
                                                            </li>
                                                        <li class="order-total clearfix">
                                                            <h6>Total</h6>
                                                            <span>
                                                             ${parseInt(Number(totalbill) - (Number(totalbill) * coupon.discount) / 100)}
                                                            </span>
                                                        </li>
                                                    </div>  `
                                userCouponCart.innerHTML = html

                            }
                            else if (response.couponErr) {
                                error = response.couponErr
                                console.log(error);
                                let couponError = document.getElementById('couponError')
                                let html = null
                                html = `<div id="couponError">
                                    <h6 style="color:red;"> ${error}
                                    </div>`
                                couponError.innerHTML = html
                            }
                        }
                    })
                }
                function checkout() {
                    const error = document.getElementById('errorMsg')
                    const name = document.getElementById('name')
                    const phone = document.getElementById('phone')
                    const address = document.getElementById('address')
                    const city = document.getElementById('city')
                    const zip = document.getElementById('zip')
                    const state = document.getElementById('state')
                    const cod = document.getElementById('cod')
                    const netbanking = document.getElementById('netbanking')
                    if (name.value == '' || name.value == null) {
                        $('#name').after(`<span class="error text-danger">Please fill this form</span>`)
                        
                    } else if (phone.value == '' || phone.value == null || isNaN(phone.value )) {

                        $('#phone').after(`<span class="error text-danger">Please fill this form/enter valid number</span>`)
                    } else if (address.value == '' || address.value == null) {
                        $('#address').after(`<span class="error text-danger">Please fill this form</span>`)

                    }
                    else if (zip.value == '' || zip.value == null ||  isNaN(zip.value)) {
                        $('#zip').after(`<span class="error text-danger">Please fill this form/enter valid pincode</span>`)

                    } else if (city.value == '' || city.value == null) {
                        $('#city').after(`<span class="error text-danger">Please fill this form</span>`)
                    } else if (state.value == "" || state.value == null) {
                        $('#state').after(`<span class="error text-danger">Enter State</span>`)

                    } else if (!cod.checked && !netbanking.checked) {
                        $('#inner').after(`<span class="error text-danger">Please choose one</span>`)

                    }
                    else {
                       
                        $.ajax(
                            {
                                url: '/check-out',
                                method: 'post',
                                data: $('#checkoutform').serialize(),
                                success: (response) => {
                                    if (response.codSuccess, response.orderId) {
                                        orderId = response.orderId
                                        
                                        console.log(orderId)
                                        swal.fire({
                                            icon: 'success',
                                            title: 'order has been placed Succesfully',
                                            showClass: {
                                                popup: 'animate__animated animate__fadeInDown'
                                            },
                                            hideClass: {
                                                popup: 'animate__animated animate__fadeOutUp'
                                            },
                                            showConfirmButton: true,
                                        }).then(() => {
                                            window.location.href = "/orderSuccess/" + orderId;
                                        })
                                    } else {
                                        razorPayPayment(response)
                                    }
                                }
                            })
                        function razorPayPayment(order) {
                            var options = {
                                "key": "rzp_test_BUnir6WHXKvN1B", // Enter the Key ID generated from the Dashboard
                                "amount": order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                "currency": "INR",
                                "name": "BeYou",
                                "description": "Test Transaction",
                                "image": "https://example.com/your_logo",
                                "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                "handler": function (response) {
                                   

                                    verifyPayment(response, order)
                                },
                                "prefill": {
                                    "name": "Gaurav Kumar",
                                    "email": "gaurav.kumar@example.com",
                                    "contact": "9999999999"
                                },
                                "notes": {
                                    "address": "Razorpay Corporate Office"
                                },
                                "theme": {
                                    "color": "#3399cc"
                                }

                            };
                            var rzp1 = new Razorpay(options);
                            rzp1.open();

                            function verifyPayment(payment, order) {
                                $.ajax({
                                    url: '/verify-payment',
                                    data: { payment, order },
                                    method: 'post',
                                    success: (response) => {
                                        if (response.status, response.orderId) {
                                            orderId = response.orderId
                                            console.log("oiiii");
                                            console.log(orderId);
                                            swal.fire({
                                                icon: 'success',
                                                title: 'order has been placed Succesfully',
                                                showClass: {
                                                    popup: 'animate__animated animate__fadeInDown'
                                                },
                                                hideClass: {
                                                    popup: 'animate__animated animate__fadeOutUp'
                                                },
                                                showConfirmButton: true,
                                            }).then(() => {
                                                window.location.href = "/orderSuccess/" + orderId;
                                                // instead of directing to homepage direct it to a success page
                                            })
                                        } else {
                                            alert("payment failed")
                                        }
                                    }
                                })
                            }
                        }
                    }

                }
            </script>

            <%- include('./includes/script')%>